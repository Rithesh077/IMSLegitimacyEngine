<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Management Portal</title>
    <!-- Google Fonts: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            /* Branding & Colors */
            --primary: #4f46e5;
            /* Indigo-600 */
            --primary-hover: #4338ca;
            /* Indigo-700 */
            --secondary: #64748b;
            /* Slate-500 */
            --bg-body: #f8fafc;
            /* Slate-50 */
            --bg-sidebar: #0f172a;
            /* Slate-900 */
            --text-sidebar: #e2e8f0;
            /* Slate-200 */
            --bg-card: #ffffff;
            --text-main: #1e293b;
            /* Slate-800 */
            --text-muted: #64748b;
            /* Slate-500 */
            --border-color: #e2e8f0;
            /* Slate-200 */
            --danger: #ef4444;
            /* Red-500 */
            --success: #10b981;
            /* Emerald-500 */
            --warning: #f59e0b;
            /* Amber-500 */
            --sidebar-width: 280px;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-body);
            color: var(--text-main);
            height: 100vh;
            overflow: hidden;
        }

        .app-container {
            display: flex;
            height: 100%;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-sidebar);
            color: var(--text-sidebar);
            display: flex;
            flex-direction: column;
            padding: 24px;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease;
            position: relative;
            z-index: 10;
        }

        .sidebar h2 {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2.5rem;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.025em;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            color: #94a3b8;
            /* Slate-400 */
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.95rem;
            margin-bottom: 4px;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            color: #f1f5f9;
        }

        .nav-item.active {
            background-color: var(--primary);
            color: #fff;
            box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 30px;
            position: relative;
        }

        .view-section {
            display: none;
            max-width: 1000px;
            margin: 0 auto;
            animation: fadeIn 0.4s ease;
        }

        .view-section.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            text-align: center;
        }

        .stat-card h3 {
            margin: 0 0 10px 0;
            color: #64748b;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            color: #2563eb;
        }

        /* Modal Styles */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Cards */
        /* Cards */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 32px;
            box-shadow: var(--shadow-md);
            margin-bottom: 24px;
            border: 1px solid rgba(226, 232, 240, 0.6);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .card:hover {
            box-shadow: var(--shadow-lg);
        }

        .card h3 {
            margin-top: 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
            letter-spacing: -0.01em;
        }

        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            font-size: 0.9rem;
            color: #475569;
            /* Slate-600 */
        }

        input[type="text"],
        input[type="password"],
        input[type="email"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.95rem;
            color: var(--text-main);
            background-color: #fff;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.1);
        }

        /* Buttons */
        .btn-group {
            display: flex;
            gap: 16px;
            margin-top: 24px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            border-radius: 8px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 0.95rem;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        button:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.2);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(79, 70, 229, 0.3);
        }

        .btn-secondary {
            background-color: white;
            border: 1px solid var(--border-color);
            color: var(--text-main);
        }

        .btn-secondary:hover {
            border-color: #94a3b8;
            background-color: #f8fafc;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.2);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #059669;
            /* Emerald-600 */
            box-shadow: 0 4px 6px -1px rgba(16, 185, 129, 0.2);
        }

        /* Internship Items */
        .internship-item {
            background: #fff;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 16px;
            transition: transform 0.2s;
        }

        .internship-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .item-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-PENDING {
            background-color: #fef3c7;
            color: #b45309;
        }

        .status-APPROVED {
            background-color: #dcfce7;
            color: #15803d;
        }

        .status-REJECTED {
            background-color: #fee2e2;
            color: #b91c1c;
        }

        .item-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
            font-size: 0.9rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .item-row {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .item-desc {
            color: var(--text-main);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed var(--border-color);
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
            cursor: pointer;
        }

        .hidden {
            display: none !important;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--text-main);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.2s;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: var(--text-main);
        }

        .insight-badge {
            padding: 4px 12px;
            border-radius: 9999px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .insight-badge.success {
            background: #dcfce7;
            color: #15803d;
        }

        .insight-badge.warning {
            background: #fef3c7;
            color: #b45309;
        }
    </style>
</head>

<body>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>IMS Portal</h2>
                <div class="nav-items">
                    <div class="nav-item active" onclick="switchView('corporate')" id="nav-corporate">
                        <span>Corporate</span>
                    </div>
                    <div class="nav-item hidden" onclick="switchView('corporate-applications')"
                        id="nav-corporate-applications">
                        <span>Applications</span>
                    </div>
                    <div class="nav-item" onclick="switchView('placement')" id="nav-placement">
                        <span>Placement</span>
                    </div>
                    <div class="nav-item" onclick="switchView('student')" id="nav-student">
                        <span>Student</span>
                    </div>
                    <div class="nav-item" onclick="switchView('admin')" id="nav-admin">
                        <span>Admin Login</span>
                    </div>

                    <!-- Placement Menu Items -->
                    <div id="placement-menu-items" class="hidden">
                        <div
                            style="padding: 10px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-top: 10px;">
                            Management</div>
                        <div class="nav-item active" id="nav-placement-pending"
                            onclick="switchPlacementSubView('pending')">
                            <span>Pending Approvals</span>
                        </div>
                        <div class="nav-item" id="nav-placement-approved" onclick="switchPlacementSubView('approved')">
                            <span>Approved Internships</span>
                        </div>
                    </div>

                    <!-- Admin Specific Menu -->
                    <div id="admin-menu-items" class="hidden">
                        <div
                            style="padding: 10px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-top: 10px;">
                            Overview</div>
                        <div class="nav-item" onclick="switchAdminSubView('dashboard')" id="nav-admin-dashboard">
                            <span>üìä Dashboard</span>
                        </div>

                        <div
                            style="padding: 10px 15px; color: #64748b; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; font-weight: 700; margin-top: 10px;">
                            Management</div>
                        <div class="nav-item" onclick="switchAdminSubView('users')" id="nav-admin-users">
                            <span>üë• Users</span>
                        </div>
                        <div class="nav-item" onclick="switchAdminSubView('internships')" id="nav-admin-internships">
                            <span>üíº Internships</span>
                        </div>
                        <div class="nav-item" onclick="switchAdminSubView('departments')" id="nav-admin-departments">
                            <span>üè¢ Departments</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="sidebar-footer hidden" id="global-logout-area">
                <button class="btn-danger" style="width:100%" onclick="logoutCurrent()">Logout</button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">

            <!-- CORPORATE VIEW -->
            <div id="corporate-view" class="view-section active">

                <!-- Login Section -->
                <div id="corp-login-section" class="card">
                    <h3>Corporate Access</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="corp-email" value="corp@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="corp-pass" value="password123">
                    </div>
                    <div class="btn-group">
                        <button class="btn-primary" onclick="login('corporate')">Login</button>
                        <button class="btn-secondary" onclick="registerCorp()">Register New Corp</button>
                    </div>
                </div>

                <!-- Dashboard Actions -->
                <div id="corp-actions" class="hidden">
                    <div class="card">
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <h3 style="margin:0; border:none;">Manage Internships</h3>
                            <button class="btn-primary" onclick="openAddModal()">‚ûï Add Internship</button>
                        </div>
                    </div>
                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0; border:none;">My Listings</h3>
                            <button class="btn-secondary" onclick="loadMyInternships()">Refresh</button>
                        </div>
                        <div id="corp-int-list"></div>
                    </div>
                </div>
            </div>

            <!-- CORPORATE APPLICATIONS VIEW -->
            <div id="corporate-applications-view" class="view-section">
                <div class="card">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0; border:none;">Internship Applications</h3>
                        <button class="btn-secondary" onclick="loadCorporateApplications()">Refresh</button>
                    </div>
                    <div id="corp-apps-list"></div>
                </div>
            </div>

            <!-- PLACEMENT VIEW -->
            <div id="placement-view" class="view-section">
                <div id="place-login-section" class="card">
                    <h3>Placement Cell Access</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="place-email" value="placement@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="place-pass" value="password123">
                    </div>
                    <div class="btn-group">
                        <button class="btn-primary" onclick="login('placement')">Login</button>
                    </div>
                </div>

                <div id="place-actions" class="hidden">
                    <div id="placement-pending-view" class="placement-subview">
                        <div class="card">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0; border:none;">Pending Approvals</h3>
                                <button class="btn-secondary" onclick="loadPendingInternships()">Refresh</button>
                            </div>
                            <div id="place-int-list"></div>
                        </div>
                    </div>

                    <div id="placement-approved-view" class="placement-subview hidden">
                        <div class="card">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0; border:none;">Approved Internships</h3>
                                <button class="btn-secondary"
                                    onclick="loadApprovedInternshipsForPlacement()">Refresh</button>
                            </div>
                            <div id="place-approved-list">
                                <p style="color:var(--text-muted); text-align:center;">No approved internships yet.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- STUDENT VIEW -->
            <div id="student-view" class="view-section">
                <div id="stud-login-section" class="card">
                    <h3>Student Portal</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="stud-email" value="student@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="stud-pass" value="password123">
                    </div>
                    <div class="btn-group">
                        <button class="btn-primary" onclick="login('student')">Login</button>
                    </div>
                </div>

                <div id="stud-actions" class="hidden">
                    <div class="card">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <h3 style="margin:0; border:none;">Available Opportunities</h3>
                            <button class="btn-secondary" onclick="loadApprovedInternships()">Refresh</button>
                        </div>
                        <div id="stud-int-list"></div>
                    </div>
                </div>
            </div>



            <!-- ADMIN VIEW (MAIN) -->
            <div id="admin-view" class="view-section">
                <div id="admin-login-section" class="card">
                    <h3>Admin Panel Access</h3>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="text" id="admin-email" value="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="admin-pass" value="password123">
                    </div>
                    <div class="btn-group">
                        <button class="btn-primary" onclick="login('admin')">Login</button>
                    </div>
                </div>

                <div id="admin-actions" class="hidden">

                    <!-- 1. DASHBOARD VIEW -->
                    <div id="admin-dashboard-view" class="admin-subview">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <h3>Total Users</h3>
                                <div class="number" id="stat-users">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>Internships</h3>
                                <div class="number" id="stat-internships">-</div>
                            </div>
                            <div class="stat-card">
                                <h3>Companies</h3>
                                <div class="number" id="stat-companies">-</div>
                            </div>
                        </div>

                        <!-- Charts Section -->
                        <div
                            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                            <div class="card">
                                <h3>üë• Users by Role</h3>
                                <canvas id="chart-roles"></canvas>
                            </div>
                            <div class="card">
                                <h3>üíº Internships by Status</h3>
                                <canvas id="chart-status"></canvas>
                            </div>
                            <div class="card" style="grid-column: 1 / -1;">
                                <h3>üè¢ Internships by Department</h3>
                                <canvas id="chart-depts" style="max-height: 300px;"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- 2. USERS VIEW -->
                    <div id="admin-users-view" class="admin-subview hidden">
                        <div class="card">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0; border:none;">Manage Users</h3>
                                <div style="display:flex; gap:10px;">
                                    <button class="btn-primary" onclick="openAddUserModal()">+ Add User</button>
                                    <button class="btn-secondary" onclick="loadAdminUsers()">Refresh</button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table style="width:100%; border-collapse:collapse;">
                                    <thead>
                                        <tr
                                            style="text-align:left; background:#f8fafc; border-bottom:2px solid #e2e8f0;">
                                            <th style="padding:12px;">Name</th>
                                            <th style="padding:12px;">Email</th>
                                            <th style="padding:12px;">Role</th>
                                            <th style="padding:12px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-users-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- 3. INTERNSHIPS VIEW -->
                    <div id="admin-internships-view" class="admin-subview hidden">
                        <div class="card">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0; border:none;">All Internships</h3>
                                <button class="btn-secondary" onclick="loadAdminInternships()">Refresh</button>
                            </div>
                            <div id="admin-internships-list"></div>
                        </div>
                    </div>

                    <!-- 4. DEPARTMENTS VIEW -->
                    <div id="admin-departments-view" class="admin-subview hidden">
                        <div class="card">
                            <div
                                style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                                <h3 style="margin:0; border:none;">Manage Departments</h3>
                                <button class="btn-primary" onclick="openAddDeptModal()">+ Add New</button>
                            </div>
                            <div class="table-container">
                                <table style="width:100%; border-collapse:collapse;">
                                    <thead>
                                        <tr
                                            style="text-align:left; background:#f8fafc; border-bottom:2px solid #e2e8f0;">
                                            <th style="padding:12px;">Name</th>
                                            <th style="padding:12px;">ID</th>
                                            <th style="padding:12px;">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="admin-departments-list"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

        </main>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>‚úèÔ∏è Edit Internship</h3>
                <button class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Title <span style="color: red;">*</span></label>
                <input type="text" id="edit-title" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Department <span style="color: red;">*</span></label>
                    <select id="edit-dept" required></select>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <select id="edit-location">
                        <option value="REMOTE">Remote</option>
                        <option value="ONSITE">Onsite</option>
                        <option value="HYBRID">Hybrid</option>
                    </select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Duration <span style="color: red;">*</span></label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="edit-duration" placeholder="e.g. 6" min="1" required>
                        <select id="edit-duration-unit">
                            <option value="Days">Days</option>
                            <option value="Months" selected>Months</option>
                            <option value="Years">Years</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Stipend details</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="edit-paid" onchange="toggleEditStipend()">
                        <label for="edit-paid" style="margin:0; cursor:pointer;">Top-tier Paid Internship?</label>
                    </div>
                    <input type="text" id="edit-stipend" placeholder="Amount (e.g. ‚Çπ25,000/mo)" class="hidden">
                </div>
            </div>
            <div class="form-group">
                <label>Description <span style="color: red;">*</span></label>
                <textarea id="edit-desc" rows="4" required></textarea>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="saveEdit()">Update Internship</button>
                <button class="btn-secondary" onclick="closeEditModal()">Cancel</button>
            </div>
        </div>
    </div>
    <!-- Add Modal -->
    <div id="add-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üöÄ Add New Internship</h3>
                <button class="modal-close" onclick="closeAddModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Title <span style="color: red;">*</span></label>
                <input type="text" id="add-title" placeholder="e.g. Frontend Developer" required>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Department <span style="color: red;">*</span></label>
                    <select id="add-dept" required>
                        <!-- Populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <select id="add-location">
                        <option value="REMOTE">Remote</option>
                        <option value="ONSITE">Onsite</option>
                        <option value="HYBRID">Hybrid</option>
                    </select>
                </div>
            </div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <div class="form-group">
                    <label>Duration <span style="color: red;">*</span></label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <input type="number" id="add-duration" placeholder="e.g. 6" min="1" required>
                        <select id="add-duration-unit">
                            <option value="Days">Days</option>
                            <option value="Months" selected>Months</option>
                            <option value="Years">Years</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Stipend details</label>
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="add-paid" onchange="toggleAddStipend()">
                        <label for="add-paid" style="margin:0; cursor:pointer;">Top-tier Paid Internship?</label>
                    </div>
                    <input type="text" id="add-stipend" placeholder="Amount (e.g. ‚Çπ25,000/mo)" class="hidden">
                </div>
            </div>
            <div class="form-group">
                <label>Description <span style="color: red;">*</span></label>
                <textarea id="add-desc" rows="4" placeholder="Detailed job description..." required></textarea>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="saveAdd()">Post Internship</button>
                <button class="btn-secondary" onclick="closeAddModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Add User Modal -->
    <div id="add-user-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ Add New User</h3>
                <button class="modal-close" onclick="closeAddUserModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Full Name <span style="color: red;">*</span></label>
                <input type="text" id="new-user-name" placeholder="John Doe" required>
            </div>
            <div class="form-group">
                <label>Email Address <span style="color: red;">*</span></label>
                <input type="email" id="new-user-email" placeholder="john@example.com" required>
            </div>
            <div class="form-group">
                <label>Password <span style="color: red;">*</span></label>
                <input type="password" id="new-user-pass" placeholder="Uncrackable password" required>
            </div>
            <div class="form-group">
                <label>Role <span style="color: red;">*</span></label>
                <select id="new-user-role" onchange="toggleCorporateFields()">
                    <option value="STUDENT">Student</option>
                    <option value="PLACEMENT">Placement Officer</option>
                    <option value="CORPORATE">Corporate</option>
                    <option value="ADMIN">Admin</option>
                    <option value="FACULTY">Faculty</option>
                </select>
            </div>

            <!-- Corporate Fields -->
            <div id="corporate-fields" class="hidden"
                style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0;">
                <div class="form-group">
                    <label>Company Name <span style="color: red;">*</span></label>
                    <input type="text" id="new-corp-name" placeholder="Acme Corp">
                </div>
                <div class="form-group">
                    <label>HR Contact Name</label>
                    <input type="text" id="new-corp-hr" placeholder="HR Manager Name">
                </div>
            </div>

            <!-- Student Fields -->
            <div id="student-fields" class="hidden"
                style="background:#f8fafc; padding:15px; border-radius:8px; margin-bottom:15px; border:1px solid #e2e8f0;">
                <div class="form-group">
                    <label>Department <span style="color: red;">*</span></label>
                    <select id="new-stud-dept">
                        <option value="">Select Department...</option>
                        <!-- Populated by JS -->
                    </select>
                </div>
            </div>

            <div class="btn-group">
                <button class="btn-primary" onclick="saveNewUser()">Create User</button>
                <button class="btn-secondary" onclick="closeAddUserModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Admin Add Department Modal -->
    <div id="add-dept-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üè¢ Add New Department</h3>
                <button class="modal-close" onclick="closeAddDeptModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Department Name <span style="color: red;">*</span></label>
                <input type="text" id="new-dept-name" placeholder="e.g. Computer Science" required>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="saveNewDept()">Create Department</button>
                <button class="btn-secondary" onclick="closeAddDeptModal()">Cancel</button>
            </div>
        </div>
    </div>

    </div>

    <!-- Department Analytics Modal -->
    <div id="dept-analytics-modal" class="modal-overlay hidden">
        <div class="modal-content" style="max-width: 900px; width: 90%;">
            <div class="modal-header">
                <h3>üìä Department Analytics</h3>
                <button class="modal-close" onclick="closeDeptAnalyticsModal()">&times;</button>
            </div>
            <div id="dept-analytics-content" style="padding: 10px;">
                <!-- Content populated by JS -->
            </div>
        </div>
    </div>

    <!-- Apply Modal -->
    <div id="apply-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üìù Apply for Internship</h3>
                <button class="modal-close" onclick="closeApplyModal()">&times;</button>
            </div>
            <div class="form-group">
                <label>Resume (PDF/Doc) <span style="color: red;">*</span></label>
                <input type="file" id="apply-resume" accept=".pdf,.doc,.docx" required>
            </div>
            <div class="form-group">
                <label>GitHub Profile</label>
                <input type="url" id="apply-github" placeholder="https://github.com/username"
                    pattern="https?://(www\.)?github\.com/.+"
                    title="Please enter a valid GitHub URL (e.g., https://github.com/username)">
                <small style="color: #64748b; display: block; margin-top: 4px;">Must be a GitHub URL</small>
            </div>
            <div class="form-group">
                <label>LinkedIn Profile</label>
                <input type="url" id="apply-linkedin" placeholder="https://linkedin.com/in/username"
                    pattern="https?://(www\.)?linkedin\.com/(in|company)/.+"
                    title="Please enter a valid LinkedIn URL (e.g., https://linkedin.com/in/username)">
                <small style="color: #64748b; display: block; margin-top: 4px;">Must be a LinkedIn URL</small>
            </div>
            <div class="btn-group">
                <button class="btn-primary" onclick="submitApplication()">Submit Application</button>
                <button class="btn-secondary" onclick="closeApplyModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Applicants View Modal -->
    <div id="applicants-modal" class="modal hidden">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h3>Internship Applicants</h3>
                <button class="modal-close" onclick="closeApplicantsModal()">&times;</button>
            </div>
            <div id="applicants-modal-body" style="max-height: 60vh; overflow-y: auto;">
                <!-- Applicants table will be loaded here -->
                <div style="text-align:center; color:#64748b;">Loading...</div>
            </div>
            <div class="btn-group" style="justify-content: flex-end;">
                <button class="btn-secondary" onclick="closeApplicantsModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Auto-detect environment and use appropriate API URL
        const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
        const API_URL = isLocalhost ? 'http://localhost:8000' : 'https://internshipportal-4iul.onrender.com';
        let tokens = {
            corporate: localStorage.getItem('token_corporate'),
            placement: localStorage.getItem('token_placement'),
            student: localStorage.getItem('token_student'),
            faculty: localStorage.getItem('token_faculty'),
            admin: localStorage.getItem('token_admin')
        };

        let departments = [];
        let departmentsLoaded = false;
        let myInternships = [];
        let editingInternshipId = null;
        let applyingInternshipId = null;
        let autoRefreshInterval = null;
        let currentAdminSubView = 'dashboard';
        let currentPlacementSubView = 'pending';
        let adminChartInstances = {};

        function log(msg) {
            const time = new Date().toLocaleTimeString();
            console.log(`[${time}] ${msg}`);
        }

        function switchView(viewName) {
            // Update Nav
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-${viewName}`).classList.add('active');

            // Update View
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById(`${viewName}-view`).classList.add('active');

            // Trigger Data Load
            if (autoRefreshInterval) clearInterval(autoRefreshInterval);

            if (viewName === 'admin') {
                switchAdminSubView('dashboard');
            } else {
                loadDataForView(viewName);
            }

            // Auto-refresh disabled to prevent modal closing
            // autoRefreshInterval = setInterval(() => loadDataForView(viewName), 5000);
        }

        function loadDataForView(viewName) {
            if (viewName === 'corporate') {
                loadDepartments('corporate');
                if (tokens.corporate) loadMyInternships();
            }
            if (viewName === 'corporate-applications' && tokens.corporate) {
                loadCorporateApplications();
            }
            if (viewName === 'placement' && tokens.placement) {
                if (currentPlacementSubView === 'pending') loadPendingInternships();
                else if (currentPlacementSubView === 'approved') loadApprovedInternshipsForPlacement();
            }
            if (viewName === 'student' && tokens.student) loadApprovedInternships();
            if (viewName === 'admin' && tokens.admin) {
                if (currentAdminSubView === 'dashboard') loadAdminDashboard();
                else if (currentAdminSubView === 'users') loadAdminUsers();
                else if (currentAdminSubView === 'departments') loadAdminDepartments();
                else if (currentAdminSubView === 'internships') loadAdminInternships();
            }
        }

        function switchPlacementSubView(subView) {
            currentPlacementSubView = subView;
            // Update Nav
            document.querySelectorAll('#placement-menu-items .nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById(`nav-placement-${subView}`).classList.add('active');

            // Update View
            document.querySelectorAll('.placement-subview').forEach(el => el.classList.add('hidden'));
            document.getElementById(`placement-${subView}-view`).classList.remove('hidden');

            // Load Data
            if (subView === 'pending') loadPendingInternships();
            if (subView === 'approved') loadApprovedInternshipsForPlacement();
        }

        function switchAdminSubView(subView) {
            currentAdminSubView = subView;
            // Update Nav - only within admin menu
            document.querySelectorAll('#admin-menu-items .nav-item').forEach(el => el.classList.remove('active'));
            const navEl = document.getElementById(`nav-admin-${subView}`);
            if (navEl) navEl.classList.add('active');

            // Update View
            document.querySelectorAll('.admin-subview').forEach(el => el.classList.add('hidden'));
            document.getElementById(`admin-${subView}-view`).classList.remove('hidden');

            // Load Data
            if (subView === 'dashboard') loadAdminDashboard();
            if (subView === 'users') loadAdminUsers();
            if (subView === 'internships') loadAdminInternships();
            if (subView === 'departments') loadAdminDepartments();
        }

        async function loadAdminDashboard() {
            try {
                const stats = await apiRequest('/admin/stats', 'GET', null, 'admin');
                document.getElementById('stat-users').innerText = stats.total_users;
                document.getElementById('stat-internships').innerText = stats.total_internships;
                document.getElementById('stat-companies').innerText = stats.corporate_count;

                if (stats.charts) renderAdminCharts(stats.charts);
            } catch (error) { console.error('Failed to load stats:', error); }
        }

        function renderAdminCharts(data) {
            // Helper to create/update chart
            const createChart = (id, type, label, labels, values, colors) => {
                const chart = adminChartInstances[id];
                if (chart) {
                    // Update existing
                    chart.data.labels = labels;
                    chart.data.datasets[0].data = values;
                    chart.update('none'); // 'none' mode prevents full re-animation
                } else {
                    // Create new
                    const ctx = document.getElementById(id).getContext('2d');
                    adminChartInstances[id] = new Chart(ctx, {
                        type: type,
                        data: {
                            labels: labels,
                            datasets: [{
                                label: label,
                                data: values,
                                backgroundColor: colors,
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { position: 'bottom' } }
                        }
                    });
                }
            };

            // 1. Users by Role (Pie)
            const roleLabels = Object.keys(data.users_by_role);
            const roleValues = Object.values(data.users_by_role);
            createChart('chart-roles', 'doughnut', 'Users', roleLabels, roleValues,
                ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6']);

            // 2. Internships by Status (Pie)
            const statusLabels = Object.keys(data.internships_by_status);
            const statusValues = Object.values(data.internships_by_status);
            createChart('chart-status', 'pie', 'Status', statusLabels, statusValues,
                ['#10b981', '#f59e0b', '#ef4444', '#64748b']);

            // 3. Internships by Dept (Bar)
            const deptLabels = Object.keys(data.internships_by_dept);
            const deptValues = Object.values(data.internships_by_dept);
            createChart('chart-depts', 'bar', 'Internships', deptLabels, deptValues, '#3b82f6');
        }

        async function loadAdminUsers() {
            try {
                const users = await apiRequest('/admin/users', 'GET', null, 'admin');
                document.getElementById('admin-users-list').innerHTML = users.map(u => `
                    <tr style="border-bottom:1px solid #e2e8f0;">
                         <td style="padding:12px; font-weight:500;">${u.name}</td>
                         <td style="padding:12px; color:#64748b;">${u.email}</td>
                         <td style="padding:12px;">
                            <span style="padding:4px 8px; border-radius:12px; font-size:0.8rem; font-weight:600; background-color: ${getRoleColor(u.role)}; color:white;">${u.role}</span>
                         </td>
                         <td style="padding:12px;">
                            ${u.role !== 'ADMIN' ? `<button class="btn-danger" style="padding:4px 8px; font-size:0.8rem;" onclick="deleteUser('${u.id}')">Delete</button>` : ''}
                         </td>
                    </tr>
                `).join('');
            } catch (error) { console.error('Failed to load users:', error); }
        }

        async function deleteUser(id) {
            if (!confirm('Are you sure? This action implies deleting all related data.')) return;
            try {
                await apiRequest(`/admin/users/${id}`, 'DELETE', null, 'admin');
                loadAdminUsers();
            } catch (e) { alert(e.message); }
        }

        async function loadAdminInternships() {
            try {
                const items = await apiRequest('/admin/internships', 'GET', null, 'admin');
                document.getElementById('admin-internships-list').innerHTML = items.map(i => `
                    <div class="internship-item" style="border-left: 4px solid ${i.status === 'APPROVED' ? '#10b981' : (i.status === 'CLOSED' ? '#ef4444' : '#f59e0b')}">
                        <div style="display:flex; justify-content:space-between;">
                            <strong>${i.title}</strong>
                            <span class="status-badge status-${i.status}">${i.status}</span>
                        </div>
                        <div style="font-size:0.9rem; color:#64748b;">${i.corporate ? i.corporate.company_name : 'Unknown Corp'} | ${i.department ? i.department.name : 'Unknown Dept'}</div>
                        <div style="margin-top:10px;">
                            <button class="btn-danger" style="padding:4px 10px; font-size:0.85rem;" onclick="deleteAdminInternship('${i.id}')">Force Delete</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) { console.error('Failed to load internships:', error); }
        }

        async function deleteAdminInternship(id) {
            if (!confirm('Permanently delete this internship?')) return;
            try {
                await apiRequest(`/admin/internships/${id}`, 'DELETE', null, 'admin');
                loadAdminInternships();
            } catch (e) { alert(e.message); }
        }

        async function loadAdminDepartments() {
            try {
                const depts = await apiRequest('/admin/departments', 'GET', null, 'admin');
                const listEl = document.getElementById('admin-departments-list');
                if (!listEl) return;

                listEl.innerHTML = depts.map(d => `
                    <tr style="border-bottom:1px solid #e2e8f0; cursor:pointer; transition:background 0.2s;" 
                        onmouseover="this.style.background='#f1f5f9'" 
                        onmouseout="this.style.background='transparent'"
                        onclick="showDepartmentAnalytics('${d.id}')">
                         <td style="padding:12px; font-weight:500;">${d.name}</td>
                         <td style="padding:12px; color:#64748b; font-family:monospace;">${d.id}</td>
                         <td style="padding:12px;">
                            <button class="btn-danger" style="padding:4px 8px; font-size:0.8rem;" 
                                onclick="event.stopPropagation(); deleteDepartment('${d.id}')">Delete</button>
                         </td>
                    </tr>
                `).join('');
            } catch (error) { console.error('Failed to load depts:', error); }
        }

        function openAddDeptModal() {
            document.getElementById('add-dept-modal').classList.remove('hidden');
            document.getElementById('new-dept-name').value = '';
        }

        function closeAddDeptModal() {
            document.getElementById('add-dept-modal').classList.add('hidden');
        }

        async function saveNewDept() {
            const name = document.getElementById('new-dept-name').value;
            if (!name) {
                alert('Please enter a department name');
                return;
            }
            try {
                await apiRequest('/departments', 'POST', { name }, 'admin');
                closeAddDeptModal();
                loadAdminDepartments();
            } catch (e) { alert(e.message); }
        }

        async function deleteDepartment(id) {
            if (!confirm('Delete this department?')) return;
            try {
            } catch (e) { alert(e.message); }
        }

        // Global chart instances for department analytics to handle cleanup
        let deptStatusChart = null;
        let deptFunnelChart = null;

        async function showDepartmentAnalytics(deptId) {
            const modal = document.getElementById('dept-analytics-modal');
            const content = document.getElementById('dept-analytics-content');

            // Modern Loading State
            content.innerHTML = `
                <div style="display:flex; flex-direction:column; align-items:center; justify-content:center; padding:40px;">
                    <div class="loader" style="border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top:15px; color:var(--text-muted);">Fetching Department Insights...</p>
                </div>
            `;
            modal.classList.remove('hidden');

            try {
                const analytics = await apiRequest(`/admin/departments/${deptId}/analytics`, 'GET', null, 'admin');
                const appsByStatus = analytics.applications_by_status || {};

                // --- INSIGHTS GENERATION ---
                let insightHtml = '';
                if (analytics.success_rate > 75) {
                    insightHtml = `<div class="insight-badge success">üåü Top Performing Department</div>`;
                } else if (analytics.success_rate < 30 && analytics.total_applications > 5) {
                    insightHtml = `<div class="insight-badge warning">‚ö†Ô∏è Attention Needed: Low Conversion</div>`;
                }

                // --- PREMIUM UI LAYOUT ---
                content.innerHTML = `
                    <div id="analytics-report-area">
                        <div style="margin-bottom:25px; text-align:center;">
                            <div style="display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom:10px;">
                                <h2 style="font-size:1.8rem; margin:0; color:var(--text-dark); background: linear-gradient(135deg, var(--primary), #4f46e5); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">${analytics.department}</h2>
                                ${insightHtml}
                            </div>
                            <p style="color:var(--text-muted); margin-top:5px; font-weight:500;">Performance & Engagement Overview</p>
                            <p style="font-size:0.85rem; color:#94a3b8;">Report Generated: ${new Date().toLocaleDateString()}</p>
                        </div>
                        
                        <!-- KPI CARDS -->
                        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap:15px; margin-bottom:30px;">
                            <div class="stat-card" style="position:relative; overflow:hidden;">
                                <div style="position:absolute; top:-10px; right:-10px; font-size:4rem; opacity:0.05; transform:rotate(-15deg);">üë•</div>
                                <h3 style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; opacity:0.8;">Total Students</h3>
                                <div class="number" style="font-size:2rem;">${analytics.total_students}</div>
                            </div>
                            <div class="stat-card" style="position:relative; overflow:hidden;">
                                <div style="position:absolute; top:-10px; right:-10px; font-size:4rem; opacity:0.05; transform:rotate(-15deg);">üìÑ</div>
                                <h3 style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; opacity:0.8;">Applications</h3>
                                <div class="number" style="font-size:2rem;">${analytics.total_applications}</div>
                            </div>
                            <div class="stat-card" style="position:relative; overflow:hidden;">
                                <div style="position:absolute; top:-10px; right:-10px; font-size:4rem; opacity:0.05; transform:rotate(-15deg);">‚úÖ</div>
                                <h3 style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; opacity:0.8;">Placements</h3>
                                <div class="number" style="color:#10b981; font-size:2rem;">${analytics.total_accepted}</div>
                            </div>
                            <div class="stat-card" style="position:relative; overflow:hidden;">
                                <div style="position:absolute; top:-10px; right:-10px; font-size:4rem; opacity:0.05; transform:rotate(-15deg);">üöÄ</div>
                                <h3 style="font-size:0.85rem; text-transform:uppercase; letter-spacing:0.5px; opacity:0.8;">Success Rate</h3>
                                <div class="number" style="color:${analytics.success_rate >= 50 ? '#10b981' : (analytics.success_rate >= 20 ? '#f59e0b' : '#ef4444')}; font-size:2rem;">
                                    ${analytics.success_rate}%
                                </div>
                            </div>
                        </div>

                        <!-- CHARTS SECTION -->
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px;">
                            <!-- Status Distribution -->
                            <div class="card" style="box-shadow:none; border:1px solid #e2e8f0; padding:15px; display:flex; flex-direction:column; align-items:center;">
                                <h4 style="margin:0 0 15px 0; color:var(--text-dark);">Application Status</h4>
                                <div style="width:100%; height:200px; position:relative;">
                                    <canvas id="deptStatusChart"></canvas>
                                </div>
                            </div>

                            <!-- Funnel / Activity -->
                            <div class="card" style="box-shadow:none; border:1px solid #e2e8f0; padding:15px; display:flex; flex-direction:column; align-items:center;">
                                <h4 style="margin:0 0 15px 0; color:var(--text-dark);">Conversion Funnel</h4>
                                <div style="width:100%; height:200px; position:relative;">
                                    <canvas id="deptFunnelChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- ACTION BAR -->
                    <div style="border-top:1px solid #e2e8f0; margin-top:20px; padding-top:20px; display:flex; justify-content:flex-end; gap:10px;">
                        <button class="btn-secondary" onclick="closeDeptAnalyticsModal()">Close</button>
                        <button class="btn-primary" onclick="downloadDeptReport('${analytics.department}')">‚¨á Download Report</button>
                    </div>
                `;

                // --- RENDER CHARTS ---

                // 1. Status Chart (Doughnut)
                if (deptStatusChart) deptStatusChart.destroy();
                const statusCtx = document.getElementById('deptStatusChart').getContext('2d');

                // Prepare Data
                const labels = Object.keys(appsByStatus);
                const dataPoints = Object.values(appsByStatus);
                const bgColors = labels.map(status => {
                    if (status.includes('ACCEPTED')) return '#10b981'; // Green
                    if (status.includes('REJECTED')) return '#ef4444'; // Red
                    if (status.includes('PENDING')) return '#f59e0b'; // Amber
                    return '#6366f1'; // Default Indigo
                });

                deptStatusChart = new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: labels.length ? labels : ['No Data'],
                        datasets: [{
                            data: dataPoints.length ? dataPoints : [1], // Dummy for empty
                            backgroundColor: dataPoints.length ? bgColors : ['#e2e8f0'],
                            borderWidth: 0,
                            hoverOffset: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'right', labels: { boxWidth: 12, font: { size: 10 } } }
                        },
                        cutout: '65%'
                    }
                });

                // 2. Funnel Chart (Bar)
                if (deptFunnelChart) deptFunnelChart.destroy();
                const funnelCtx = document.getElementById('deptFunnelChart').getContext('2d');

                deptFunnelChart = new Chart(funnelCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Applied', 'Placed'],
                        datasets: [{
                            label: 'Students',
                            data: [analytics.total_applications, analytics.total_accepted],
                            backgroundColor: ['#6366f1', '#10b981'],
                            borderRadius: 6,
                            barThickness: 40
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            y: { beginAtZero: true, grid: { display: false } },
                            x: { grid: { display: false } }
                        }
                    }
                });

            } catch (e) {
                console.error(e);
                content.innerHTML = `
                    <div style="color:#ef4444; text-align:center; padding:40px;">
                        <h3 style="margin:0;">Failed to Load Analytics</h3>
                        <p>Please check your connection or server logs.</p>
                        <button class="btn-secondary" onclick="closeDeptAnalyticsModal()" style="margin-top:10px;">Close</button>
                    </div>`;
            }
        }

        function downloadDeptReport(deptName) {
            const element = document.getElementById('analytics-report-area');
            const opt = {
                margin: 0.5,
                filename: `${deptName}_Analytics_Report.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };

            // Show toast or loading
            const btn = document.querySelector('#dept-analytics-content .btn-primary');
            const originalText = btn.innerText;
            btn.innerText = 'Generating PDF...';
            btn.disabled = true;

            try {
                html2pdf().set(opt).from(element).save();
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function closeDeptAnalyticsModal() {
            document.getElementById('dept-analytics-modal').classList.add('hidden');
            // Cleanup charts
            if (deptStatusChart) deptStatusChart.destroy();
            if (deptFunnelChart) deptFunnelChart.destroy();
            deptStatusChart = null;
            deptFunnelChart = null;
        }

        // --- Admin Add User Logic ---
        function openAddUserModal() {
            document.getElementById('add-user-modal').classList.remove('hidden');
            // Reset fields
            document.getElementById('new-user-name').value = '';
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-pass').value = '';
            document.getElementById('new-user-role').value = 'STUDENT';
            toggleCorporateFields();
        }

        function closeAddUserModal() {
            document.getElementById('add-user-modal').classList.add('hidden');
        }

        async function toggleCorporateFields() {
            const role = document.getElementById('new-user-role').value;
            const corpFields = document.getElementById('corporate-fields');
            const studentFields = document.getElementById('student-fields');

            // Hide all first
            if (corpFields) corpFields.classList.add('hidden');
            if (studentFields) studentFields.classList.add('hidden');

            if (role === 'CORPORATE') {
                if (corpFields) corpFields.classList.remove('hidden');
            } else if (role === 'STUDENT') {
                if (studentFields) {
                    studentFields.classList.remove('hidden');
                    // Load departments if needed
                    const deptSelect = document.getElementById('new-stud-dept');
                    if (deptSelect && deptSelect.options.length <= 1) {
                        try {
                            const depts = await apiRequest('/admin/departments', 'GET', null, 'admin');
                            deptSelect.innerHTML = '<option value="">Select Department...</option>' +
                                depts.map(d => `<option value="${d.id}">${d.name}</option>`).join('');
                        } catch (e) { console.error('Failed to load departments', e); }
                    }
                }
            }
        }

        async function saveNewUser() {
            const name = document.getElementById('new-user-name').value;
            const email = document.getElementById('new-user-email').value;
            const password = document.getElementById('new-user-pass').value;
            const role = document.getElementById('new-user-role').value;

            if (!name || !email || !password) {
                alert('Please fill all required fields');
                return;
            }

            const payload = { name, email, password, role };

            if (role === 'CORPORATE') {
                const company = document.getElementById('new-corp-name').value;
                const hr = document.getElementById('new-corp-hr').value;
                if (!company) {
                    alert('Company Name is required for Corporate users');
                    return;
                }
                payload.company_name = company;
                payload.hr_name = hr;
            } else if (role === 'STUDENT') {
                const deptId = document.getElementById('new-stud-dept').value;
                // Make department optional or required? User asked for student to have department.
                // If required:
                if (deptId) {
                    payload.department_id = deptId;
                }
            }

            try {
                await apiRequest('/admin/users', 'POST', payload, 'admin');
                alert('User created successfully!');
                closeAddUserModal();
                loadAdminUsers();
            } catch (e) {
                alert('Failed to create user: ' + e.message);
            }
        }

        function getRoleColor(role) {
            switch (role) {
                case 'ADMIN': return '#0f172a';
                case 'CORPORATE': return '#2563eb';
                case 'PLACEMENT': return '#7c3aed';
                case 'STUDENT': return '#059669';
                default: return '#94a3b8';
            }
        }

        async function loadDepartments(role) {
            if (departmentsLoaded) return;

            // Only fetch if we have a token for the current role
            let effectiveRole = role;
            if (!tokens[effectiveRole]) {
                if (tokens.corporate) effectiveRole = 'corporate';
                else if (tokens.placement) effectiveRole = 'placement';
                else if (tokens.student) effectiveRole = 'student';
                else return; // No token, cannot fetch
            }

            try {
                const data = await apiRequest('/departments', 'GET', null, effectiveRole);
                if (Array.isArray(data)) {
                    departments = data;
                    departmentsLoaded = true;
                    const options = data.map(d => `<option value="${d.id}">${d.name}</option>`).join('');

                    // Populate all dropdowns
                    const addSelect = document.getElementById('add-dept');
                    if (addSelect) addSelect.innerHTML = options;

                    const editSelect = document.getElementById('edit-dept');
                    if (editSelect) editSelect.innerHTML = options;
                }
            } catch (e) {
                console.error("Failed to load departments", e);
            }
        }

        function toggleStipend() {
            const isPaid = document.getElementById('int-paid').checked;
            const stipendInput = document.getElementById('int-stipend');
            if (isPaid) stipendInput.classList.remove('hidden');
            else stipendInput.classList.add('hidden');
        }

        async function apiRequest(endpoint, method = 'GET', body = null, role = null) {
            const headers = {};
            if (!(body instanceof FormData)) {
                headers['Content-Type'] = 'application/json';
            }

            if (role && tokens[role]) {
                headers['Authorization'] = `Bearer ${tokens[role]}`;
            }

            const opts = {
                method,
                headers,
                body: body ? (body instanceof FormData ? body : JSON.stringify(body)) : null
            };

            try {
                const res = await fetch(`${API_URL}${endpoint}`, opts);

                if (res.status === 401) {
                    // Authentication failed - auto logout
                    console.error('Authentication failed - logging out');

                    // Determine which role failed and logout
                    // Determine which role failed and logout
                    if (role && tokens[role]) {
                        handleLogout(role);
                        alert('Your session has expired. Please login again.');
                    } else if (!role) {
                        // Clear all tokens if role is unknown
                        tokens.corporate = null;
                        tokens.placement = null;
                        tokens.student = null;
                        switchView('corporate'); // Go to login page
                        alert('Authentication failed. Please login.');
                    }

                    throw new Error('Session expired');
                }


                // Handle empty responses (e.g., from DELETE operations)
                const contentType = res.headers.get('content-type');
                const text = await res.text();

                let data = null;
                if (text && text.length > 0) {
                    try {
                        data = JSON.parse(text);
                    } catch (e) {
                        console.warn('Response is not JSON:', text);
                        data = { message: text };
                    }
                }

                if (!res.ok) {
                    let errMsg = 'Request failed';
                    if (data && data.detail) {
                        if (typeof data.detail === 'string') errMsg = data.detail;
                        else if (Array.isArray(data.detail)) errMsg = data.detail.map(e => `${e.loc.join('.')}: ${e.msg}`).join('\n');
                        else errMsg = JSON.stringify(data.detail);
                    }
                    throw new Error(errMsg);
                }
                return data;
            } catch (err) {
                if (err.message !== 'Session expired') {
                    log(`ERROR: ${err.message}`);
                    alert(err.message);
                }
                throw err;
            }
        }

        function handleLogout(role) {
            tokens[role] = null;
            localStorage.removeItem(`token_${role}`);

            // Stop any active auto-refresh
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }

            // Show Login, Hide Actions
            let prefix = role === 'placement' ? 'place' : role.substring(0, 4);
            if (role === 'corporate') prefix = 'corp';
            if (role === 'student') prefix = 'stud';
            if (role === 'admin') prefix = 'admin';

            const loginSec = document.getElementById(`${prefix}-login-section`);
            const actionSec = document.getElementById(`${prefix}-actions`);

            if (loginSec) loginSec.classList.remove('hidden');

            if (actionSec) actionSec.classList.add('hidden');

            // Hide Applications nav if logging out from corporate
            if (role === 'corporate') {
                const appsNav = document.getElementById('nav-corporate-applications');
                if (appsNav) appsNav.classList.add('hidden');
            }

            log(`${role.toUpperCase()} Logged Out/Expired.`);

            // Restore Sidebar - show all nav items
            document.getElementById('nav-corporate').classList.remove('hidden');
            document.getElementById('nav-placement').classList.remove('hidden');
            document.getElementById('nav-student').classList.remove('hidden');
            document.getElementById('nav-admin').classList.remove('hidden');
            document.getElementById('admin-menu-items').classList.add('hidden');
            document.getElementById('placement-menu-items').classList.add('hidden');

            // Hide logout button
            document.getElementById('global-logout-area').classList.add('hidden');

            // Switch to the login view for this role
            switchView(role);
        }

        function handleLoginSuccess(role, token) {
            tokens[role] = token;
            localStorage.setItem(`token_${role}`, token);
            log(`${role.toUpperCase()} Logged In.`);

            let prefix = role === 'placement' ? 'place' : role.substring(0, 4);
            if (role === 'corporate') prefix = 'corp';
            if (role === 'student') prefix = 'stud';
            if (role === 'admin') prefix = 'admin';

            // Hide Login, Show Actions
            document.getElementById(`${prefix}-login-section`).classList.add('hidden');
            document.getElementById(`${prefix}-actions`).classList.remove('hidden');

            // ISOLATE VIEW
            isolateSidebar(role);
            switchView(role); // Switch to the logged-in role's view

            loadDataForView(role);
        }

        function isolateSidebar(role) {
            // Hide all first
            ['corporate', 'corporate-applications', 'placement', 'student', 'admin'].forEach(r => {
                const el = document.getElementById(`nav-${r}`);
                if (el) el.classList.add('hidden');
            });

            // Show active
            if (role === 'admin') {
                document.getElementById('admin-menu-items').classList.remove('hidden');
                // Default to dashboard
                switchAdminSubView('dashboard');
            } else if (role === 'placement') {
                document.getElementById('placement-menu-items').classList.remove('hidden');
                switchPlacementSubView('pending');
            } else {
                document.getElementById(`nav-${role}`).classList.remove('hidden');
                if (role === 'corporate') {
                    document.getElementById('nav-corporate-applications').classList.remove('hidden');
                }
            }

            // Show Logout
            const logoutArea = document.getElementById('global-logout-area');
            if (logoutArea) {
                logoutArea.classList.remove('hidden');
                logoutArea.querySelector('button').innerText = `Logout ${role.charAt(0).toUpperCase() + role.slice(1)}`;
            }
        }

        function logoutCurrent() {
            if (tokens.corporate) handleLogout('corporate');
            if (tokens.placement) handleLogout('placement');
            if (tokens.student) handleLogout('student');
            if (tokens.admin) handleLogout('admin');
        }

        async function login(role) {
            let prefix = role === 'placement' ? 'place' : role.substring(0, 4);
            if (role === 'corporate') prefix = 'corp';
            if (role === 'student') prefix = 'stud';
            if (role === 'admin') prefix = 'admin';

            const email = document.getElementById(`${prefix}-email`).value;
            const password = document.getElementById(`${prefix}-pass`).value;
            const formData = new URLSearchParams();
            formData.append('username', email);
            formData.append('password', password);

            try {
                const res = await fetch(API_URL + '/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.detail);

                handleLoginSuccess(role, data.access_token);
            } catch (err) { alert('Login Failed: ' + err.message); }
        }

        async function registerCorp() {
            const data = {
                name: "Test Corp",
                email: document.getElementById('corp-email').value,
                password: document.getElementById('corp-pass').value,
                company_name: "Test Company Inc",
                hr_name: "HR Manager"
            };
            try {
                await apiRequest('/auth/register', 'POST', data);
                log('Corporate Registered. Please Login.');
            } catch (e) { }
        }

        /* --- CORPORATE ACTIONS --- */
        async function createInternship() {
            const data = {
                title: document.getElementById('int-title').value,
                description: document.getElementById('int-desc').value,
                department_id: document.getElementById('int-dept').value,
                location_type: document.getElementById('int-location').value,
                duration: document.getElementById('int-duration').value,
                is_paid: document.getElementById('int-paid').checked,
                stipend: document.getElementById('int-paid').checked ? document.getElementById('int-stipend').value : null
            };

            if (editingInternshipId) {
                await apiRequest(`/internships/${editingInternshipId}`, 'PATCH', data, 'corporate');
                log(`Updated Internship: ${data.title}`);
                editingInternshipId = null;
                document.getElementById('post-btn').innerText = 'Post Internship';
            } else {
                await apiRequest('/internships', 'POST', data, 'corporate');
                log(`Posted Internship: ${data.title}`);
            }
            loadMyInternships();
        }

        async function loadCorporateApplications() {
            // First load internships to show list
            const internships = await apiRequest('/internships/my', 'GET', null, 'corporate');

            document.getElementById('corp-apps-list').innerHTML = internships.map(i => `
                <div class="internship-item">
                    <div class="item-header">
                        <span class="item-title">${i.title}</span>
                        <span class="status-badge status-${i.status}">${i.status}</span>
                    </div>
                    <div style="margin-top:10px;">
                         <button class="btn-primary" onclick="viewApplicants('${i.id}')">View Applicants</button>
                    </div>
                    <div id="applicants-container-${i.id}" class="hidden" style="margin-top:15px; border-top:1px dashed #e2e8f0; padding-top:15px;">
                        <div style="text-align:center; color:#64748b;">Loading...</div>
                    </div>
                </div>
            `).join('');
        }

        function ensureAbsoluteUrl(url) {
            if (!url) return '#';
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            return 'https://' + url;
        }

        function ensureAbsoluteUrl(url) {
            if (!url) return '#';
            if (url.startsWith('http://') || url.startsWith('https://')) {
                return url;
            }
            return 'https://' + url;
        }

        async function viewApplicants(internshipId) {
            const container = document.getElementById(`applicants-container-${internshipId}`);
            if (!container.classList.contains('hidden')) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            try {
                const apps = await apiRequest(`/internships/${internshipId}/applications`, 'GET', null, 'corporate');

                if (apps.length === 0) {
                    container.innerHTML = '<div style="text-align:center; color:#64748b;">No applications yet.</div>';
                    return;
                }

                container.innerHTML = `
                    <table style="width:100%; border-collapse:collapse; font-size:0.9rem;">
                        <thead>
                            <tr style="text-align:left; background:#f8fafc; color:#64748b;">
                                <th style="padding:8px;">Student</th>
                                <th style="padding:8px;">Email</th>
                                <th style="padding:8px;">Resume</th>
                                <th style="padding:8px;">Links</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${apps.map(a => `
                                <tr style="border-bottom:1px solid #f1f5f9;">
                                    <td style="padding:8px;">${a.student.name}</td>
                                    <td style="padding:8px;">${a.student.email}</td>
                                    <td style="padding:8px;"><a href="${a.resume_link}" target="_blank" style="color:#2563eb;">View Resume</a></td>
                                    <td style="padding:12px; border-bottom:1px solid #f1f5f9;">
                                        <div style="display:flex; gap:8px;">
                                            ${a.github_link ? `<a href="${ensureAbsoluteUrl(a.github_link)}" target="_blank" title="GitHub">GitHub</a>` : ''}
                                            ${a.linkedin_link ? `<a href="${ensureAbsoluteUrl(a.linkedin_link)}" target="_blank" title="LinkedIn">LinkedIn</a>` : ''}
                                            ${!a.github_link && !a.linkedin_link ? '<span style="color:#94a3b8;">-</span>' : ''}
                                        </div>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

            } catch (e) {
                container.innerHTML = `<div style="color:red;">Failed to load applicants: ${e.message}</div>`;
            }
        }

        async function loadMyInternships() {
            myInternships = await apiRequest('/internships/my', 'GET', null, 'corporate');

            // Auto-close any rejected internships
            for (const internship of myInternships) {
                if (internship.status === 'REJECTED' && internship.is_active) {
                    try {
                        await apiRequest(`/internships/${internship.id}/close`, 'PATCH', null, 'corporate');
                        log(`Auto-closed rejected internship: ${internship.id}`);
                        // Mark as closed locally to update UI immediately
                        internship.status = 'CLOSED';
                        internship.is_active = false;
                    } catch (error) {
                        console.error(`Failed to auto-close rejected internship ${internship.id}:`, error);
                    }
                }
            }

            document.getElementById('corp-int-list').innerHTML = myInternships.map(i => `
            <div class="internship-item" style="${i.status === 'CLOSED' || i.status === 'REJECTED' ? 'opacity: 0.6; border-left: 4px solid #ef4444;' : ''}">
                ${renderInternshipContent(i)}
                ${i.status === 'CLOSED' ? '<div style="background:#ef4444; color:white; padding:4px 12px; border-radius:6px; font-size:0.85rem; font-weight:600; display:inline-block; margin-bottom:10px;">üîí CLOSED</div>' : ''}
                ${i.status === 'REJECTED' ? '<div style="background:#dc2626; color:white; padding:4px 12px; border-radius:6px; font-size:0.85rem; font-weight:600; display:inline-block; margin-bottom:10px;">‚ùå REJECTED & CLOSED</div>' : ''}
                <div class="btn-group">
                    ${i.status !== 'CLOSED' && i.status !== 'REJECTED' ? `<button class="btn-primary" onclick="editInternship('${i.id}')">Edit</button>` : ''}
                    ${i.status !== 'CLOSED' && i.status !== 'REJECTED' ? `<button class="btn-secondary" onclick="closeInternship('${i.id}')">Close</button>` : ''}
                    <button class="btn-danger" onclick="deleteInternship('${i.id}')">Delete</button>
                </div>
            </div>
        `).join('');
        }

        function editInternship(id) {
            console.log('editInternship called with ID:', id);

            const i = myInternships.find(x => x.id === id);
            console.log('Found internship:', i);

            if (!i) {
                console.error('Internship not found!');
                return;
            }

            // Populate modal form
            document.getElementById('edit-title').value = i.title;
            document.getElementById('edit-desc').value = i.description;
            if (i.department) document.getElementById('edit-dept').value = i.department.id;
            document.getElementById('edit-location').value = i.location_type;

            // Parse duration (e.g. "6 Months" -> number=6, unit="Months")
            const durationMatch = i.duration.match(/(\d+)\s*(\w+)/);
            if (durationMatch) {
                document.getElementById('edit-duration').value = durationMatch[1];
                document.getElementById('edit-duration-unit').value = durationMatch[2];
            } else {
                document.getElementById('edit-duration').value = i.duration;
                document.getElementById('edit-duration-unit').value = 'Months';
            }

            document.getElementById('edit-paid').checked = i.is_paid;

            const stipendInput = document.getElementById('edit-stipend');
            if (i.is_paid) {
                stipendInput.classList.remove('hidden');
                stipendInput.value = i.stipend || '';
            } else {
                stipendInput.classList.add('hidden');
                stipendInput.value = '';
            }

            editingInternshipId = id;
            log(`Opening edit modal for: ${i.title}`);

            // Show modal
            document.getElementById('edit-modal').classList.remove('hidden');
        }

        function closeEditModal() {
            document.getElementById('edit-modal').classList.add('hidden');
            editingInternshipId = null;
        }

        function toggleEditStipend() {
            const isPaid = document.getElementById('edit-paid').checked;
            const stipendInput = document.getElementById('edit-stipend');
            if (isPaid) {
                stipendInput.classList.remove('hidden');
            } else {
                stipendInput.classList.add('hidden');
                stipendInput.value = '';
            }
        }

        async function saveEdit() {
            if (!editingInternshipId) return;

            // Validation
            const title = document.getElementById('edit-title').value.trim();
            const description = document.getElementById('edit-desc').value.trim();
            const departmentId = document.getElementById('edit-dept').value;
            const durationValue = document.getElementById('edit-duration').value;

            if (!title) {
                alert('Please enter a title for the internship.');
                return;
            }
            if (!departmentId) {
                alert('Please select a department.');
                return;
            }
            if (!durationValue || durationValue <= 0) {
                alert('Please enter a valid duration.');
                return;
            }
            if (!description) {
                alert('Please enter a description.');
                return;
            }

            const durationUnit = document.getElementById('edit-duration-unit').value;
            const duration = `${durationValue} ${durationUnit}`;

            const data = {
                title: title,
                description: description,
                department_id: departmentId,
                location_type: document.getElementById('edit-location').value,
                duration: duration,
                is_paid: document.getElementById('edit-paid').checked,
                stipend: document.getElementById('edit-stipend').value || null
            };

            await apiRequest(`/internships/${editingInternshipId}`, 'PATCH', data, 'corporate');
            log(`Updated Internship: ${data.title}`);

            closeEditModal();
            loadMyInternships();
        }

        // Add Modal Functions
        function openAddModal() {
            // Clear form
            document.getElementById('add-title').value = '';
            document.getElementById('add-desc').value = '';
            document.getElementById('add-location').value = 'REMOTE';
            document.getElementById('add-duration').value = '';
            document.getElementById('add-duration-unit').value = 'Months';
            document.getElementById('add-paid').checked = false;
            document.getElementById('add-stipend').value = '';
            document.getElementById('add-stipend').classList.add('hidden');

            // Show modal
            document.getElementById('add-modal').classList.remove('hidden');
        }

        function closeAddModal() {
            document.getElementById('add-modal').classList.add('hidden');
        }

        function toggleAddStipend() {
            const isPaid = document.getElementById('add-paid').checked;
            const stipendInput = document.getElementById('add-stipend');
            if (isPaid) {
                stipendInput.classList.remove('hidden');
            } else {
                stipendInput.classList.add('hidden');
                stipendInput.value = '';
            }
        }

        async function saveAdd() {
            // Validation
            const title = document.getElementById('add-title').value.trim();
            const description = document.getElementById('add-desc').value.trim();
            const departmentId = document.getElementById('add-dept').value;
            const durationValue = document.getElementById('add-duration').value;

            if (!title) {
                alert('Please enter a title for the internship.');
                return;
            }
            if (!departmentId) {
                alert('Please select a department.');
                return;
            }
            if (!durationValue || durationValue <= 0) {
                alert('Please enter a valid duration.');
                return;
            }
            if (!description) {
                alert('Please enter a description.');
                return;
            }

            const durationUnit = document.getElementById('add-duration-unit').value;
            const duration = `${durationValue} ${durationUnit}`;

            const data = {
                title: title,
                description: description,
                department_id: departmentId,
                location_type: document.getElementById('add-location').value,
                duration: duration,
                is_paid: document.getElementById('add-paid').checked,
                stipend: document.getElementById('add-stipend').value || null
            };

            await apiRequest('/internships', 'POST', data, 'corporate');
            log(`Posted Internship: ${data.title}`);

            closeAddModal();
            loadMyInternships();
        }

        async function closeInternship(id) {
            if (!confirm('Are you sure you want to close this internship? It will no longer be visible to students.')) return;
            await apiRequest(`/internships/${id}/close`, 'PATCH', null, 'corporate');
            log('Internship Closed.');
            loadMyInternships();
        }

        async function deleteInternship(id) {
            if (!confirm('Are you sure you want to delete this internship? This action cannot be undone.')) return;
            try {
                await apiRequest(`/internships/${id}`, 'DELETE', null, 'corporate');
                log('Internship Deleted.');
                loadMyInternships();
            } catch (error) {
                console.error('Failed to delete internship:', error);
            }
        }

        /* --- PLACEMENT ACTIONS --- */
        async function loadPendingInternships() {
            const items = await apiRequest('/internships/pending', 'GET', null, 'placement');
            document.getElementById('place-int-list').innerHTML = items.map(i => `
            <div class="internship-item">
                ${renderInternshipContent(i)}
                <div class="btn-group">
                    <button class="btn-success" onclick="approveInt('${i.id}')">Approve</button>
                    <button class="btn-danger" onclick="rejectInt('${i.id}')">Reject</button>
                </div>
            </div>
        `).join('');
        }

        async function approveInt(id) {
            await apiRequest(`/internships/${id}/approve`, 'POST', null, 'placement');
            log(`Approved ${id}`);
            loadPendingInternships();
        }
        async function rejectInt(id) {
            try {
                // First reject the internship
                await apiRequest(`/internships/${id}/reject`, 'POST', null, 'placement');
                log(`Rejected ${id}`);

                // Then automatically close it so students can't see it
                await apiRequest(`/internships/${id}/close`, 'PATCH', null, 'placement');
                log(`Auto-closed rejected internship ${id}`);

                loadPendingInternships();
                loadApprovedInternshipsForPlacement(); // Refresh approved list too
            } catch (error) {
                console.error('Error during rejection:', error);
                // Still refresh the list even if there was an error
                loadPendingInternships();
                loadApprovedInternshipsForPlacement();
            }
        }

        async function loadApprovedInternshipsForPlacement() {
            const items = await apiRequest('/internships/approved', 'GET', null, 'placement');
            document.getElementById('place-approved-list').innerHTML = items.length > 0 ? items.map(i => `
            <div class="internship-item" style="${i.is_active === false ? 'opacity: 0.6; border-left: 4px solid #94a3b8;' : ''}">
                ${renderInternshipContent(i)}
                ${i.is_active === false ? '<div style="background:#94a3b8; color:white; padding:4px 12px; border-radius:6px; font-size:0.85rem; font-weight:600; display:inline-block; margin-bottom:10px;">üîí CLOSED</div>' : ''}
                <div class="btn-group">
                    ${i.is_active !== false ? `<button class="btn-danger" onclick="rejectApprovedInt('${i.id}')">Cancel Approval</button>` : ''}
                </div>
            </div>
        `).join('') : '<p style="color: #94a3b8; text-align: center; padding: 20px;">No approved internships yet.</p>';
        }

        async function rejectApprovedInt(id) {
            if (!confirm('Are you sure you want to cancel the approval for this internship? It will be rejected and closed.')) return;

            try {
                // Reject the internship
                await apiRequest(`/internships/${id}/reject`, 'POST', null, 'placement');
                log(`Cancelled approval and rejected ${id}`);

                // Auto-close it
                await apiRequest(`/internships/${id}/close`, 'PATCH', null, 'placement');
                log(`Auto-closed rejected internship ${id}`);

                loadApprovedInternshipsForPlacement();
            } catch (error) {
                console.error('Error during rejection:', error);
                loadApprovedInternshipsForPlacement();
            }
        }

        /* --- STUDENT ACTIONS --- */
        async function loadApprovedInternships() {
            const items = await apiRequest('/internships/approved', 'GET', null, 'student');
            document.getElementById('stud-int-list').innerHTML = items.map(i => `
            <div class="internship-item">
                ${renderInternshipContent(i)}
                <div class="btn-group">
                    ${i.has_applied
                    ? '<span class="status-badge" style="background:#d1fae5; color:#065f46; border: 1px solid #6ee7b7; padding: 10px 20px; font-size: 0.95rem; border-radius: 6px; display: inline-block;">‚úì Already Applied</span>'
                    : `<button class="btn-primary" onclick="openApplyModal('${i.id}')">Apply Now</button>`
                }
                </div>
            </div>
        `).join('');
        }

        /* --- APPLY MODAL ACTIONS --- */
        function openApplyModal(id) {
            applyingInternshipId = id;
            document.getElementById('apply-resume').value = '';
            document.getElementById('apply-github').value = '';
            document.getElementById('apply-linkedin').value = '';
            document.getElementById('apply-modal').classList.remove('hidden');
        }

        function closeApplyModal() {
            document.getElementById('apply-modal').classList.add('hidden');
            applyingInternshipId = null;
        }

        async function submitApplication() {
            if (!applyingInternshipId) return;

            const resumeInput = document.getElementById('apply-resume');
            const github = document.getElementById('apply-github').value.trim();
            const linkedin = document.getElementById('apply-linkedin').value.trim();

            if (resumeInput.files.length === 0) {
                alert('Please upload your resume.');
                return;
            }

            const formData = new FormData();
            formData.append('resume', resumeInput.files[0]);
            if (github) formData.append('github_link', github);
            if (linkedin) formData.append('linkedin_link', linkedin);

            try {
                await apiRequest(`/internships/${applyingInternshipId}/apply`, 'POST', formData, 'student');
                log('Application Submitted Successfully!');
                alert('Application Submitted Successfully!');
                closeApplyModal();
            } catch (e) {
                // Error handling is done in apiRequest, but we can catch here if needed
            }
        }

        /* --- HELPERS --- */
        function renderInternshipContent(i) {
            const stipendInfo = i.is_paid ? `Paid (${i.stipend})` : 'Unpaid';
            return `
            <div class="item-header">
                <span class="item-title">${i.title}</span>
                <span class="status-badge status-${i.status}">${i.status}</span>
            </div>
            <div class="item-details">
                <div class="item-row"><span>üè¢</span> ${i.department ? i.department.name : 'Unknown Dept'}</div>
                <div class="item-row"><span>üìç</span> ${i.location_type}</div>
                <div class="item-row"><span>üí∞</span> ${stipendInfo}</div>
                <div class="item-row"><span>‚è≥</span> ${i.duration}</div>
            </div>
            <div class="item-desc">${i.description}</div>
            <div style="font-size:0.8rem; color:#94a3b8; margin-top:5px;">ID: ${i.id}</div>
        `;
        }

        /* --- INITIALIZATION --- */
        (function init() {
            log('System Initialized. Checking for existing session...');

            // Check if any role has a valid token and restore session
            let restoredRole = null;

            if (tokens.corporate) {
                restoredRole = 'corporate';
            } else if (tokens.placement) {
                restoredRole = 'placement';
            } else if (tokens.student) {
                restoredRole = 'student';
            } else if (tokens.admin) {
                restoredRole = 'admin';
            }


            if (restoredRole) {
                log(`Restoring ${restoredRole.toUpperCase()} session...`);

                // Restore the UI state for the logged-in role
                handleLoginSuccess(restoredRole, tokens[restoredRole]);

                // Switch to the appropriate view
                switchView(restoredRole);
            } else {
                log('No existing session found. Showing login page.');

                // Ensure all nav items are visible
                document.getElementById('nav-corporate').classList.remove('hidden');
                document.getElementById('nav-placement').classList.remove('hidden');
                document.getElementById('nav-student').classList.remove('hidden');

                // Default to corporate login view
                switchView('corporate');
            }
        })();

    </script>
</body>

</html>